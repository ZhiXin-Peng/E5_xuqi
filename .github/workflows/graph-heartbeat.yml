name: Graph Heartbeat (OIDC)

on:
  push:
    branches: [ main ]         # 改成你实际分支
  schedule:
    - cron: "11 3 * * 1"       # 每周一定时(UTC)；可改
  workflow_dispatch: {}

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    permissions:
      id-token: write           # 必须：OIDC
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Azure login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENANT_ID }}
          allow-no-subscriptions: true

      - name: Acquire Graph token via Azure CLI
        id: graphtoken
        run: |
          set -euo pipefail
          AZ_TOKEN=$(az account get-access-token --resource-type ms-graph --query accessToken -o tsv)
          test -n "$AZ_TOKEN" || { echo "Failed to get Graph token via OIDC"; exit 1; }
          echo "token=$AZ_TOKEN" >> "$GITHUB_OUTPUT"

      - name: PUT heartbeat to OneDrive
        env:
          TOKEN: ${{ steps.graphtoken.outputs.token }}
          TARGET_UPN: ${{ secrets.TARGET_UPN }}
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y%m%d-%H%M%S")
          CONTENT="GitHub OIDC heartbeat at ${TS} (commit ${GITHUB_SHA})"
          RES=$(curl -sS -X PUT \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: text/plain" \
            --data "${CONTENT}" \
            "https://graph.microsoft.com/v1.0/users/${TARGET_UPN}/drive/root:/Dev-Heartbeat/heartbeat-${TS}.txt:/content")
          echo "$RES" | jq -r '.id, .name'
