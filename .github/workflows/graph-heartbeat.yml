name: "E5 Dev Activity (OIDC + Build + OneDrive/Dev-Heartbeat + Teams)"

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "7 2 * * 1,3,5"     # 每周一/三/五 02:07 UTC
  workflow_dispatch: {}

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      # 目标 OneDrive 用户与 Azure 应用（按你之前提供的值）
      UPN: "pzx@wzhmk.onmicrosoft.com"
      TENANT_ID: "e77be010-7134-4688-b3a1-63ebbdaafe4c"
      CLIENT_ID: "da2d13f6-c585-4e42-8846-d182c26d6ef3"

      # 构建参数（若不是 Node 项目，请改 BUILD_COMMAND 与 BUILD_OUTPUT_PATH）
      BUILD_COMMAND: "npm ci && npm run build"
      BUILD_OUTPUT_PATH: "dist"
      ARTIFACT_NAME: "build-output"

      # 你的 Teams Webhook（建议后续放入 Secret：secrets.TEAMS_WEBHOOK_URL）
      TEAMS_WEBHOOK_URL: "https://wzhmk.webhook.office.com/webhookb2/6508d725-573a-4733-947d-a9cad095b53e@e77be010-7134-4688-b3a1-63ebbdaafe4c/IncomingWebhook/d10988c901f94ce6a9019626e1067528/868f8e01-61d3-4170-ae9d-aa301c782b7a/V2b4kxka0UIt78iSavnuZIwU8-9NOCvvjDqQG72UN_Ggk1"

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      # ---------- 可选：Node 项目示例 ----------
      - name: "Setup Node (optional)"
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: "Build project"
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            echo "Detected Node project. Running: ${BUILD_COMMAND}"
            bash -lc "${BUILD_COMMAND}"
          else
            echo "No package.json found. Skipping build (customize BUILD_COMMAND if needed)."
          fi
          # 确保产物目录存在，写入一条构建信息
          mkdir -p "${BUILD_OUTPUT_PATH}"
          echo "build-run: $(date -u)" > "${BUILD_OUTPUT_PATH}/_build_info.txt"

      # ---------- 打包构建产物 ----------
      - name: "Pack build output"
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y%m%d-%H%M%S")
          ZIP="build-${TS}.zip"
          (cd "${BUILD_OUTPUT_PATH}" && zip -rq "../${ZIP}" .)
          echo "zip_name=${ZIP}" >> "$GITHUB_OUTPUT"

      # ---------- 上传到 GitHub Artifacts ----------
      - name: "Upload artifact to GitHub"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ steps.pack.outputs.zip_name }}
          if-no-files-found: error
          retention-days: 14

      # ---------- OIDC 登录 Azure（无密钥） ----------
      - name: "Azure login with OIDC"
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          allow-no-subscriptions: true

      # ---------- 获取 Graph 访问令牌 ----------
      - name: "Acquire Microsoft Graph token"
        id: graphtoken
        shell: bash
        run: |
          set -euo pipefail
          AZ_TOKEN=$(az account get-access-token --resource-type ms-graph --query accessToken -o tsv)
          test -n "$AZ_TOKEN" || { echo "Failed to acquire Microsoft Graph token"; exit 1; }
          echo "token=$AZ_TOKEN" >> "$GITHUB_OUTPUT"

      # ---------- 读：驱动器配额（可选） ----------
      - name: "Read Drive quota"
        id: read_quota
        env:
          TOKEN: ${{ steps.graphtoken.outputs.token }}
          UPN:   ${{ env.UPN }}
        shell: bash
        run: |
          set -euo pipefail
          RESP=$(curl -sS -H "Authorization: Bearer ${TOKEN}" "https://graph.microsoft.com/v1.0/users/${UPN}/drive")
          USED=$(echo "$RESP"  | jq -r '.quota.used')
          TOTAL=$(echo "$RESP" | jq -r '.quota.total')
          echo "quota_used=${USED:-0}"   >> "$GITHUB_OUTPUT"
          echo "quota_total=${TOTAL:-0}" >> "$GITHUB_OUTPUT"
          echo "Drive quota: used=${USED:-0}, total=${TOTAL:-0}"

      # ---------- 上传构建 ZIP 到 OneDrive /Dev-Heartbeat ----------
      - name: "Upload build ZIP to OneDrive/Dev-Heartbeat"
        id: upload_zip
        env:
          TOKEN: ${{ steps.graphtoken.outputs.token }}
          UPN:   ${{ env.UPN }}
          ZIP:   ${{ steps.pack.outputs.zip_name }}
        shell: bash
        run: |
          set -euo pipefail
          URL="https://graph.microsoft.com/v1.0/users/${UPN}/drive/root:/Dev-Heartbeat/${ZIP}:/content"
          RESP=$(curl -sS -w "\n%{http_code}" -X PUT \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/zip" \
            --data-binary "@${ZIP}" \
            "${URL}")
          CODE=$(echo "$RESP" | tail -n1)
          echo "zip_http_code=$CODE" >> "$GITHUB_OUTPUT"
          [ "$CODE" -lt 300 ] || { echo "Upload ZIP failed with HTTP $CODE"; exit 1; }

      # ---------- 写：本次运行日志也放到 OneDrive /Dev-Heartbeat ----------
      - name: "Append run log to OneDrive/Dev-Heartbeat"
        id: run_log
        env:
          TOKEN:      ${{ steps.graphtoken.outputs.token }}
          UPN:        ${{ env.UPN }}
          ZIP_NAME:   ${{ steps.pack.outputs.zip_name }}
          QUOTA_USED: ${{ steps.read_quota.outputs.quota_used }}
          QUOTA_TOT:  ${{ steps.read_quota.outputs.quota_total }}
        shell: bash
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y%m%d-%H%M%S")
          LOGFILE="log-${TS}.txt"
          CONTENT=$'E5 Dev Activity Log\n'"timestamp=${TS}\ncommit=${GITHUB_SHA}\nzip=${ZIP_NAME}\nquota_used=${QUOTA_USED:-0}\nquota_total=${QUOTA_TOT:-0}"
          URL="https://graph.microsoft.com/v1.0/users/${UPN}/drive/root:/Dev-Heartbeat/${LOGFILE}:/content"
          RESP=$(curl -sS -w "\n%{http_code}" -X PUT \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: text/plain" \
            --data "${CONTENT}" \
            "${URL}")
          CODE=$(echo "$RESP" | tail -n1)
          echo "log_http_code=$CODE" >> "$GITHUB_OUTPUT"
          [ "$CODE" -lt 300 ] || { echo "Upload log failed with HTTP $CODE"; exit 1; }

      # ---------- Teams 通知（Incoming Webhook；已修正 jq 条件表达式问题） ----------
      - name: "Notify Teams"
        if: always()   # 失败也通知
        env:
          TEAMS_WEBHOOK_URL: ${{ env.TEAMS_WEBHOOK_URL }}   # 建议换成 secrets.TEAMS_WEBHOOK_URL
          RUN_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          ZIP_NAME: ${{ steps.pack.outputs.zip_name }}
          ZIP_CODE: ${{ steps.upload_zip.outputs.zip_http_code }}
          LOG_CODE: ${{ steps.run_log.outputs.log_http_code }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${TEAMS_WEBHOOK_URL:-}" ]; then
            echo "TEAMS_WEBHOOK_URL empty; skip."
            exit 0
          fi
          STATUS="Succeeded"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="Failed"
          fi
          COLOR="2EB886"
          if [ "$STATUS" = "Failed" ]; then
            COLOR="E81123"
          fi
          PAYLOAD=$(jq -n \
            --arg title "E5 Dev Activity: $STATUS" \
            --arg run   "$RUN_URL" \
            --arg zip   "$ZIP_NAME" \
            --arg zc    "${ZIP_CODE:-n/a}" \
            --arg lc    "${LOG_CODE:-n/a}" \
            --arg color "$COLOR" \
            '{ "@type":"MessageCard", "@context":"https://schema.org/extensions",
               "summary": $title,
               "themeColor": $color,
               "title": $title,
               "sections":[
                 { "facts":[
                     {"name":"Run","value":$run},
                     {"name":"Artifact","value":$zip},
                     {"name":"ZIP HTTP","value":$zc},
                     {"name":"LOG HTTP","value":$lc}
                   ]}
               ] }')
          curl -sS -H "Content-Type: application/json" -d "$PAYLOAD" "${TEAMS_WEBHOOK_URL}" -o /dev/null

      # ---------- 汇总摘要 ----------
      - name: "Post run summary"
        env:
          ZIP_NAME:   ${{ steps.pack.outputs.zip_name }}
          ZIP_CODE:   ${{ steps.upload_zip.outputs.zip_http_code }}
          LOG_CODE:   ${{ steps.run_log.outputs.log_http_code }}
          QUOTA_USED: ${{ steps.read_quota.outputs.quota_used }}
          QUOTA_TOT:  ${{ steps.read_quota.outputs.quota_total }}
        shell: bash
        run: |
          set -euo pipefail
          NOW_UTC=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          STATUS="✅ Success"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="❌ Failure"
          fi
          {
            printf '## E5 Dev Activity Summary\n\n'
            printf -- '- **Run time**: %s\n' "${NOW_UTC}"
            printf -- '- **Artifact**: %s\n' "${ZIP_NAME}"
            printf -- '- **OneDrive Dev-Heartbeat (ZIP) HTTP**: %s\n' "${ZIP_CODE:-n/a}"
            printf -- '- **OneDrive Dev-Heartbeat (LOG) HTTP**: %s\n' "${LOG_CODE:-n/a}"
            printf -- '- **Drive quota**: used=%s total=%s\n' "${QUOTA_USED:-0}" "${QUOTA_TOT:-0}"
            printf -- '- **Result**: %s\n' "${STATUS}"
          } >> "$GITHUB_STEP_SUMMARY"
