name: Graph Heartbeat (OIDC - Read + Write)

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "7 2 * * 1,3,5"    # æ¯å‘¨ä¸€ã€ä¸‰ã€äº” 02:07 UTCï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š10:07ï¼‰
  workflow_dispatch: {}

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      # === Azure ç™»å½•ï¼ˆOIDCï¼Œæ— å¯†é’¥ï¼‰ ===
      - name: Azure login with OIDC
        uses: azure/login@v2
        with:
          client-id: da2d13f6-c585-4e42-8846-d182c26d6ef3
          tenant-id: e77be010-7134-4688-b3a1-63ebbdaafe4c
          allow-no-subscriptions: true

      # === è·å– Microsoft Graph Token ===
      - name: Acquire Microsoft Graph token
        id: graphtoken
        run: |
          set -euo pipefail
          echo "Requesting Microsoft Graph token via OIDC..."
          AZ_TOKEN=$(az account get-access-token --resource-type ms-graph --query accessToken -o tsv)
          if [ -z "$AZ_TOKEN" ]; then
            echo "âŒ Failed to acquire Microsoft Graph token"
            exit 1
          fi
          echo "âœ… Token acquired successfully"
          echo "token=$AZ_TOKEN" >> "$GITHUB_OUTPUT"

      # === è¯»å– OneDrive æ ¹ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼ˆè¯»æ“ä½œï¼‰ ===
      - name: Read OneDrive file list
        env:
          TOKEN: ${{ steps.graphtoken.outputs.token }}
        run: |
          set -euo pipefail
          echo "ğŸ“‚ Reading OneDrive root file list..."
          curl -sS -X GET \
            -H "Authorization: Bearer ${TOKEN}" \
            "https://graph.microsoft.com/v1.0/users/pzx@wzhmk.onmicrosoft.com/drive/root/children" \
            | jq -r '.value[] | "\(.name) (\(.lastModifiedDateTime))"' | head -n 10
          echo "âœ… Read operation complete (showing top 10 files)"

      # === å†™å…¥å¿ƒè·³æ–‡ä»¶ï¼ˆå†™æ“ä½œï¼‰ ===
      - name: Write heartbeat file to OneDrive
        env:
          TOKEN: ${{ steps.graphtoken.outputs.token }}
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y%m%d-%H%M%S")
          CONTENT="GitHub OIDC heartbeat at ${TS} (commit ${GITHUB_SHA})"
          URL="https://graph.microsoft.com/v1.0/users/pzx@wzhmk.onmicrosoft.com/drive/root:/Dev-Heart
